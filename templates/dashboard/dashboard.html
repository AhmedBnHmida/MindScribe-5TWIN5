{% extends 'base.html' %}
{% block title %}Tableau de Bord - MindScribe{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --secondary: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #06b6d4;
    --dark: #1f2937;
    --light: #f8fafc;
    --gray: #6b7280;
    --border: #e5e7eb;
}

.dashboard-body {
    background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%);
    min-height: 100vh;
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
}

.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 15px;
}

/* Header Styles */
.dashboard-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.dashboard-header h1 {
    color: var(--dark);
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.dashboard-header p {
    color: var(--gray);
    font-size: 0.95rem;
    margin-bottom: 15px;
}

.header-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
}

.btn-bilan {
    background: linear-gradient(135deg, var(--secondary), var(--info));
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.btn-bilan:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    color: white;
    text-decoration: none;
}

.btn-analyse-rapide {
    background: linear-gradient(135deg, var(--primary), var(--warning));
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

.btn-analyse-rapide:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    color: white;
    text-decoration: none;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 18px;
    margin-bottom: 25px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 18px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

.stat-icon {
    font-size: 1.8rem;
    margin-bottom: 10px;
    opacity: 0.8;
}

.stat-number {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--dark);
    margin-bottom: 5px;
    line-height: 1;
}

.stat-label {
    color: var(--gray);
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 25px;
}

@media (max-width: 1200px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

.chart-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}

.chart-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
}

.chart-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--dark);
    margin: 0;
}

.chart-actions {
    display: flex;
    gap: 8px;
}

.btn-chart {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    background: var(--light);
    color: var(--gray);
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-chart:hover {
    background: var(--primary);
    color: white;
}

/* Word Cloud */
#wordcloud {
    width: 100%;
    height: 300px;
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.08);
    position: relative;
    min-height: 200px;
}

/* Timeline */
.timeline {
    max-height: 300px;
    overflow-y: auto;
    padding-right: 8px;
}

.timeline::-webkit-scrollbar {
    width: 4px;
}

.timeline::-webkit-scrollbar-track {
    background: var(--light);
    border-radius: 2px;
}

.timeline::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 2px;
}

.timeline-event {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border-left: 3px solid var(--primary);
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
    position: relative;
}

.timeline-event:hover {
    transform: translateX(3px);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
}

.timeline-event.positive { border-left-color: var(--secondary); }
.timeline-event.neutral { border-left-color: var(--warning); }
.timeline-event.negative { border-left-color: var(--danger); }

.timeline-date {
    font-weight: 700;
    color: var(--dark);
    font-size: 0.8rem;
    margin-bottom: 6px;
}

.timeline-title {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 4px;
    font-size: 0.95rem;
}

.timeline-desc {
    color: var(--gray);
    font-size: 0.8rem;
    margin-bottom: 8px;
}

.timeline-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.timeline-tag {
    background: var(--light);
    color: var(--gray);
    padding: 3px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 500;
}

/* Additional Charts Grid */
.additional-charts {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 18px;
    margin-bottom: 25px;
}

@media (max-width: 1400px) {
    .additional-charts {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .additional-charts {
        grid-template-columns: 1fr;
    }
}

.small-chart {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 18px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    position: relative;
    min-height: 250px;
}

.small-chart-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 15px;
    text-align: center;
}

/* Loading States */
.loading {
    text-align: center;
    padding: 25px;
    color: var(--gray);
}

.loading-spinner {
    border: 2px solid var(--light);
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Mood Indicator */
.mood-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
}

.mood-emoji {
    font-size: 1.5rem;
}

.mood-text {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--dark);
}

/* Filters */
.filters {
    display: flex;
    gap: 12px;
    margin-bottom: 18px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 8px 16px;
    border: 1px solid var(--border);
    background: white;
    color: var(--gray);
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.filter-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
}

/* États d'erreur et vides */
.chart-error, .chart-empty {
    text-align: center;
    padding: 50px 20px;
    color: #6b7280;
    font-size: 0.9rem;
}

.chart-error {
    color: #ef4444;
}

.chart-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #9ca3af;
    text-align: center;
}

.chart-placeholder i {
    font-size: 2rem;
    margin-bottom: 10px;
    opacity: 0.5;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-body">
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h1>🧠 Tableau de Bord Personnel</h1>
                    <p>Explorez vos patterns émotionnels et votre évolution personnelle</p>
                </div>
                <div class="header-actions">
                    <!-- Bouton Analyse Rapide -->
                    <a href="http://localhost:8000/dashboard/analyse-rapide/" class="btn-analyse-rapide">
                        <i class="fas fa-bolt"></i>
                        Analyse Rapide
                    </a>
                    <!-- Bouton de redirection vers le bilan mensuel -->
                    <a href="http://localhost:8000/dashboard/bilan-mensuel/" class="btn-bilan">
                        <i class="fas fa-chart-pie"></i>
                        Voir le Bilan Mensuel
                    </a>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="filters">
                <button class="filter-btn active" data-period="all">Tout</button>
                <button class="filter-btn" data-period="week">Cette semaine</button>
                <button class="filter-btn" data-period="month">Ce mois</button>
                <button class="filter-btn" data-period="year">Cette année</button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-number" id="total-analyses">-</div>
                <div class="stat-label">Entrées analysées</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">😊</div>
                <div class="mood-indicator">
                    <span class="mood-emoji" id="mood-emoji">-</span>
                    <span class="mood-text" id="mood-text">Humeur moyenne</span>
                </div>
                <div class="stat-label">État émotionnel</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div class="stat-number" id="themes-uniques">-</div>
                <div class="stat-label">Thèmes uniques</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔑</div>
                <div class="stat-number" id="mots-cles">-</div>
                <div class="stat-label">Mots-clés détectés</div>
            </div>
        </div>

        <!-- Main Charts Grid -->
        <div class="charts-grid">
            <!-- Evolution Humeur -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">📈 Évolution de l'Humeur</h3>
                    <div class="chart-actions">
                        <button class="btn-chart" data-chart="line">Ligne</button>
                        <button class="btn-chart" data-chart="bar">Barres</button>
                    </div>
                </div>
                <canvas id="humeurChart"></canvas>
            </div>

            <!-- Word Cloud -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">☁️ Nuage de Mots</h3>
                    <div class="chart-actions">
                        <button class="btn-chart" onclick="refreshWordCloud()">Actualiser</button>
                    </div>
                </div>
                <div id="wordcloud">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Chargement du nuage de mots...</div>
                    </div>
                </div>
            </div>

            <!-- Thèmes Dominants -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">🎯 Thèmes Dominants</h3>
                    <div class="chart-actions">
                        <button class="btn-chart" data-chart="horizontal">Horizontal</button>
                        <button class="btn-chart" data-chart="vertical">Vertical</button>
                    </div>
                </div>
                <canvas id="themesChart"></canvas>
            </div>

            <!-- Chronologie -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">🗓️ Chronologie Récente</h3>
                    <div class="chart-actions">
                        <button class="btn-chart" onclick="loadMoreTimeline()">Voir plus</button>
                    </div>
                </div>
                <div class="timeline" id="timeline">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Chargement de la chronologie...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Charts -->
        <div class="additional-charts">
            <!-- Distribution Humeurs -->
            <div class="small-chart">
                <h4 class="small-chart-title">📊 Distribution des Humeurs</h4>
                <canvas id="distributionChart"></canvas>
            </div>

            <!-- Fréquence Écriture -->
            <div class="small-chart">
                <h4 class="small-chart-title">✍️ Fréquence d'Écriture</h4>
                <canvas id="frequenceChart"></canvas>
            </div>

            <!-- Score Émotionnel -->
            <div class="small-chart">
                <h4 class="small-chart-title">💫 Score Émotionnel</h4>
                <canvas id="scoreChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
<script>
// Configuration globale
const config = {
    currentPeriod: 'all',
    charts: {}
};

// Fonction de debug pour vérifier les APIs
async function debugAPIs() {
    console.log('🔍 Début du debug des APIs...');
    const endpoints = [
        '/dashboard/api/wordcloud/',
        '/dashboard/api/frequence-ecriture/', 
        '/dashboard/api/score-emotionnel/',
        '/dashboard/api/statistiques/',
        '/dashboard/api/evolution-humeur/',
        '/dashboard/api/themes/',
        '/dashboard/api/chronologie/',
        '/dashboard/api/distribution-humeurs/'
    ];
    
    for (const endpoint of endpoints) {
        try {
            const response = await fetch(endpoint);
            const data = await response.json();
            console.log(`✅ ${endpoint}:`, data);
        } catch (error) {
            console.error(`❌ ${endpoint}:`, error);
        }
    }
    console.log('🔍 Fin du debug des APIs');
}

// Fonctions principales
async function chargerDonnees() {
    console.log('🔄 Chargement des données...');
    await Promise.all([
        chargerStatistiques(),
        chargerEvolutionHumeur(),
        chargerWordCloud(),
        chargerThemes(),
        chargerChronologie(),
        chargerDistributionHumeurs(),
        chargerFrequenceEcriture(),
        chargerScoreEmotionnel()
    ]);
    console.log('✅ Toutes les données chargées');
}

async function chargerStatistiques() {
    try {
        const response = await fetch('/dashboard/api/statistiques/');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('total-analyses').textContent = data.total_analyses || '0';
            document.getElementById('themes-uniques').textContent = data.themes_uniques || '0';
            document.getElementById('mots-cles').textContent = data.mots_cles || '0';
            
            // Mise à jour de l'humeur moyenne
            const moodEmoji = document.getElementById('mood-emoji');
            const moodText = document.getElementById('mood-text');
            if (data.humeur_moyenne) {
                const moodMap = {
                    'positif': { emoji: '😊', text: 'Positif' },
                    'neutre': { emoji: '😐', text: 'Neutre' },
                    'negatif': { emoji: '😞', text: 'Négatif' }
                };
                const mood = moodMap[data.humeur_moyenne] || moodMap['neutre'];
                moodEmoji.textContent = mood.emoji;
                moodText.textContent = mood.text;
            }
        } else {
            console.error('Erreur API statistiques:', data.error);
        }
    } catch (error) {
        console.error('Erreur chargement statistiques:', error);
        document.getElementById('total-analyses').textContent = '0';
        document.getElementById('themes-uniques').textContent = '0';
        document.getElementById('mots-cles').textContent = '0';
    }
}

async function chargerEvolutionHumeur() {
    try {
        const response = await fetch(`/dashboard/api/evolution-humeur/?period=${config.currentPeriod}`);
        const data = await response.json();
        
        const ctx = document.getElementById('humeurChart').getContext('2d');
        
        if (config.charts.humeur) {
            config.charts.humeur.destroy();
        }
        
        if (data.success && data.dates && data.dates.length > 0) {
            config.charts.humeur = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Score Humeur',
                        data: data.scores,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: data.scores.map(score => {
                            if (score > 0) return '#10b981';
                            if (score < 0) return '#ef4444';
                            return '#f59e0b';
                        }),
                        pointBorderColor: '#fff',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            min: -1,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    if (value === 1) return '😊 Positif';
                                    if (value === 0) return '😐 Neutre';
                                    if (value === -1) return '😞 Négatif';
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let humeur = 'Neutre';
                                    if (context.parsed.y > 0) humeur = 'Positif';
                                    if (context.parsed.y < 0) humeur = 'Négatif';
                                    return `Humeur: ${humeur}`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            ctx.innerHTML = '<div class="chart-empty">Aucune donnée disponible pour l\'évolution de l\'humeur</div>';
        }
    } catch (error) {
        console.error('Erreur chargement évolution humeur:', error);
        const ctx = document.getElementById('humeurChart');
        ctx.innerHTML = '<div class="chart-error">Erreur de chargement du graphique</div>';
    }
}
    
async function chargerWordCloud() {
    try {
        const response = await fetch('/dashboard/api/wordcloud/');
        const data = await response.json();
        
        console.log('Données wordcloud:', data);
        
        const container = document.getElementById('wordcloud');
        container.innerHTML = '';
        
        if (data.success && data.wordcloud && data.wordcloud.length > 0) {
            // S'assurer que les données sont au bon format
            const wordList = data.wordcloud.map(item => {
                if (Array.isArray(item)) {
                    return item; // Format [mot, fréquence]
                } else if (typeof item === 'object') {
                    return [item.mot || item.word || item.text || 'mot', item.count || item.frequency || 1];
                } else {
                    return [item, 1]; // Format de secours
                }
            });
            
            WordCloud(container, {
                list: wordList,
                gridSize: Math.round(16 * container.offsetWidth / 300),
                weightFactor: function(size) {
                    return Math.pow(size, 1.5) * container.offsetWidth / 300;
                },
                fontFamily: 'Inter, Arial, sans-serif',
                color: function(word, weight) {
                    const colors = ['#6366f1', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#06b6d4', '#ec4899'];
                    return colors[Math.floor(Math.random() * colors.length)];
                },
                rotateRatio: 0.3,
                rotationSteps: 2,
                backgroundColor: '#ffffff',
                minSize: 8,
                drawOutOfBound: false,
                shrinkToFit: true
            });
        } else {
            container.innerHTML = '<div class="chart-empty">Aucune donnée disponible pour le nuage de mots</div>';
        }
    } catch (error) {
        console.error('Erreur chargement word cloud:', error);
        const container = document.getElementById('wordcloud');
        container.innerHTML = '<div class="chart-error">Erreur de chargement du nuage de mots</div>';
    }
}

async function chargerThemes() {
    try {
        const response = await fetch('/dashboard/api/themes/');
        const data = await response.json();
        
        const ctx = document.getElementById('themesChart').getContext('2d');
        
        if (config.charts.themes) {
            config.charts.themes.destroy();
        }
        
        if (data.success && data.labels && data.labels.length > 0) {
            config.charts.themes = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Occurrences',
                        data: data.data,
                        backgroundColor: [
                            '#6366f1', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6',
                            '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#14b8a6'
                        ],
                        borderWidth: 0,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        } else {
            ctx.innerHTML = '<div class="chart-empty">Aucun thème détecté</div>';
        }
    } catch (error) {
        console.error('Erreur chargement thèmes:', error);
        const ctx = document.getElementById('themesChart');
        ctx.innerHTML = '<div class="chart-error">Erreur de chargement des thèmes</div>';
    }
}

async function chargerChronologie() {
    try {
        const response = await fetch('/dashboard/api/chronologie/');
        const data = await response.json();
        
        const timeline = document.getElementById('timeline');
        
        if (data.success && data.events && data.events.length > 0) {
            timeline.innerHTML = '';
            
            data.events.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `timeline-event ${event.ton}`;
                
                eventElement.innerHTML = `
                    <div class="timeline-date">${event.date}</div>
                    <div class="timeline-title">${event.titre}</div>
                    <div class="timeline-desc">${event.description}</div>
                    <div class="timeline-tags">
                        ${event.mots_cles && event.mots_cles.length > 0 ? 
                            event.mots_cles.map(tag => 
                                `<span class="timeline-tag">${tag}</span>`
                            ).join('') : 
                            '<span class="timeline-tag">Aucun mot-clé</span>'
                        }
                    </div>
                `;
                
                timeline.appendChild(eventElement);
            });
        } else {
            timeline.innerHTML = '<div class="chart-empty">Aucun événement récent</div>';
        }
    } catch (error) {
        console.error('Erreur chargement chronologie:', error);
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '<div class="chart-error">Erreur de chargement de la chronologie</div>';
    }
}

async function chargerDistributionHumeurs() {
    try {
        const response = await fetch('/dashboard/api/distribution-humeurs/');
        const data = await response.json();
        
        const ctx = document.getElementById('distributionChart').getContext('2d');
        
        if (config.charts.distribution) {
            config.charts.distribution.destroy();
        }
        
        if (data.success) {
            config.charts.distribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positif', 'Neutre', 'Négatif'],
                    datasets: [{
                        data: [data.positif || 0, data.neutre || 0, data.negatif || 0],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        } else {
            ctx.innerHTML = '<div class="chart-empty">Aucune donnée de distribution</div>';
        }
    } catch (error) {
        console.error('Erreur chargement distribution:', error);
        const ctx = document.getElementById('distributionChart');
        ctx.innerHTML = '<div class="chart-error">Erreur de chargement</div>';
    }
}

async function chargerFrequenceEcriture() {
    try {
        const response = await fetch('/dashboard/api/frequence-ecriture/');
        const data = await response.json();
        
        console.log('Données fréquence:', data);
        
        const ctx = document.getElementById('frequenceChart').getContext('2d');
        
        if (config.charts.frequence) {
            config.charts.frequence.destroy();
        }
        
        if (data.success && data.dates && data.dates.length > 0) {
            config.charts.frequence = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Entrées par jour',
                        data: data.counts,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} entrée(s)`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            ctx.innerHTML = '<div class="chart-empty">Aucune donnée de fréquence</div>';
        }
    } catch (error) {
        console.error('Erreur chargement fréquence:', error);
        const ctx = document.getElementById('frequenceChart');
        ctx.innerHTML = '<div class="chart-error">Erreur de chargement</div>';
    }
}

async function chargerScoreEmotionnel() {
    try {
        const response = await fetch('/dashboard/api/score-emotionnel/');
        const data = await response.json();
        
        console.log('Données score émotionnel:', data);
        
        const ctx = document.getElementById('scoreChart').getContext('2d');
        
        if (config.charts.score) {
            config.charts.score.destroy();
        }
        
        if (data.success && data.scores && data.scores.length === 5) {
            config.charts.score = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Positivité', 'Stabilité', 'Intensité', 'Diversité', 'Croissance'],
                    datasets: [{
                        label: 'Score Émotionnel',
                        data: data.scores,
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            min: 0,
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    family: 'Inter'
                                },
                                color: '#374151'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw}%`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // Données par défaut pour la démo
            const defaultScores = [75, 60, 80, 55, 70];
            config.charts.score = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Positivité', 'Stabilité', 'Intensité', 'Diversité', 'Croissance'],
                    datasets: [{
                        label: 'Score Émotionnel',
                        data: defaultScores,
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            min: 0,
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Erreur chargement score émotionnel:', error);
        const ctx = document.getElementById('scoreChart');
        ctx.innerHTML = '<div class="chart-error">Erreur de chargement</div>';
    }
}

// Fonctions utilitaires
function refreshWordCloud() {
    console.log('Actualisation du nuage de mots...');
    const container = document.getElementById('wordcloud');
    container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>Actualisation...</div></div>';
    setTimeout(() => {
        chargerWordCloud();
    }, 500);
}

function loadMoreTimeline() {
    console.log('Chargement de plus d\'événements...');
    // Implémentation pour charger plus d'événements
}

// Gestion des filtres
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        config.currentPeriod = this.dataset.period;
        console.log(`Filtre changé: ${config.currentPeriod}`);
        chargerDonnees();
    });
});

// Gestion des boutons de graphiques
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('btn-chart')) {
        const action = e.target.dataset.chart;
        if (action === 'line' || action === 'bar') {
            console.log(`Changement type graphique: ${action}`);
            // Implémentation pour changer le type de graphique
        }
    }
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initialisation du tableau de bord...');
    
    // Démarrer le chargement des données
    chargerDonnees();
    
    // Optionnel: Décommentez la ligne suivante pour debugger les APIs
    // setTimeout(debugAPIs, 1000);
});
</script>
{% endblock %}