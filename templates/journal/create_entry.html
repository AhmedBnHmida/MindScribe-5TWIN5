{% extends 'base.html' %}
{% block title %}Nouvelle Entrée de Journal{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #6366f1;
        --primary-light: rgba(99, 102, 241, 0.1);
        --primary-dark: #4f46e5;
        --secondary-color: #10b981;
        --secondary-light: rgba(16, 185, 129, 0.1);
        --accent-color: #f59e0b;
        --accent-light: rgba(245, 158, 11, 0.1);
        --danger-color: #ef4444;
        --danger-light: rgba(239, 68, 68, 0.1);
        --neutral-50: #f9fafb;
        --neutral-100: #f3f4f6;
        --neutral-200: #e5e7eb;
        --neutral-300: #d1d5db;
        --neutral-400: #9ca3af;
        --neutral-500: #6b7280;
        --neutral-600: #4b5563;
        --neutral-700: #374151;
        --neutral-800: #1f2937;
        --neutral-900: #111827;
        --glass-bg: rgba(255, 255, 255, 0.9);
        --glass-border: rgba(255, 255, 255, 0.2);
        --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --card-radius: 16px;
        --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Modern Journal Form */
    .journal-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .ultra-glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border-radius: var(--card-radius);
        border: 1px solid var(--glass-border);
        box-shadow: var(--glass-shadow);
        padding: 2rem;
        margin-bottom: 2rem;
        transition: var(--transition-smooth);
        overflow: hidden;
    }
    
    .ultra-glass-card:hover {
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    
    /* Modern Tabs */
    .ultra-tabs {
        display: flex;
        position: relative;
        border-bottom: 1px solid var(--neutral-200);
        margin-bottom: 1.5rem;
        overflow-x: auto;
        scrollbar-width: none;
    }
    
    .ultra-tabs::-webkit-scrollbar {
        display: none;
    }
    
    .ultra-tabs .nav-link {
        font-weight: 500;
        color: var(--neutral-600);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0;
        position: relative;
        transition: var(--transition-smooth);
        cursor: pointer;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .ultra-tabs .nav-link:hover {
        color: var(--primary-color);
    }
    
    .ultra-tabs .nav-link.active {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    .nav-indicator {
        position: absolute;
        bottom: -1px;
        height: 3px;
        background-color: var(--primary-color);
        border-radius: 3px;
        transition: var(--transition-smooth);
    }
    
    /* Tab Content */
    .tab-content {
        padding: 1.5rem 0;
    }
    
    /* Floating Input */
    .floating-input-group {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .floating-input {
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
        border: 2px solid var(--neutral-200);
        border-radius: 12px;
        background-color: var(--neutral-50);
        transition: var(--transition-smooth);
        min-height: 200px;
        resize: vertical;
        color: var(--neutral-800);
    }
    
    .floating-input:focus {
        outline: none;
        border-color: var(--primary-color);
        background-color: white;
        box-shadow: 0 0 0 4px var(--primary-light);
    }
    
    .floating-input:focus + .floating-label,
    .floating-input:not(:placeholder-shown) + .floating-label {
        transform: translateY(-2.5rem) scale(0.85);
        color: var(--primary-color);
        padding: 0 0.5rem;
        background-color: white;
    }
    
    .floating-label {
        position: absolute;
        top: 1rem;
        left: 1rem;
        color: var(--neutral-500);
        transition: var(--transition-smooth);
        pointer-events: none;
        transform-origin: left top;
    }
    
    /* Recording Controls */
    .recording-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 1.5rem;
        align-items: center;
    }
    
    .btn-ultra-modern {
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 500;
        transition: var(--transition-smooth);
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
    }
    
    .btn-ultra-primary {
        background-color: var(--primary-color);
        color: white;
    }
    
    .btn-ultra-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .btn-ultra-secondary {
        background-color: var(--secondary-color);
        color: white;
    }
    
    .btn-ultra-secondary:hover {
        background-color: #0ea271;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-ultra-outline {
        background-color: transparent;
        border: 2px solid var(--neutral-300);
        color: var(--neutral-700);
    }
    
    .btn-ultra-outline:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateY(-2px);
    }
    
    .btn-ultra-outline:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .recording-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--danger-color);
        font-weight: 500;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    /* File Upload */
    .ultra-file-upload {
        border: 2px dashed var(--neutral-300);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        transition: var(--transition-smooth);
        cursor: pointer;
        position: relative;
        background-color: var(--neutral-50);
    }
    
    .ultra-file-upload:hover {
        border-color: var(--primary-color);
        background-color: var(--primary-light);
    }
    
    .ultra-file-upload i {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }
    
    .ultra-file-upload .upload-text {
        font-weight: 500;
        color: var(--neutral-700);
        margin-bottom: 0.5rem;
    }
    
    .ultra-file-upload .upload-hint {
        color: var(--neutral-500);
        font-size: 0.875rem;
    }
    
    .ultra-file-upload input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }
    
    /* Card Components */
    .ultra-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: var(--transition-smooth);
        margin-bottom: 1.5rem;
    }
    
    .ultra-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .ultra-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--neutral-100);
    }
    
    .ultra-card-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background-color: var(--primary-light);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .ultra-card-icon.ultra-icon-secondary {
        background-color: var(--secondary-light);
        color: var(--secondary-color);
    }
    
    .ultra-card-icon.ultra-icon-accent {
        background-color: var(--accent-light);
        color: var(--accent-color);
    }
    
    .ultra-card h6 {
        margin: 0;
        font-weight: 600;
        color: var(--neutral-800);
    }
    
    .ultra-card-body {
        padding: 1.5rem;
    }
    
    /* Preview Containers */
    .ultra-preview {
        margin-top: 1.5rem;
    }
    
    /* Loading Spinner */
    .ultra-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 2rem;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border-radius: var(--card-radius);
        border: 1px solid var(--glass-border);
        box-shadow: var(--glass-shadow);
        margin: 2rem 0;
    }
    
    .ultra-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--primary-light);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1.5rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .ultra-loading-text {
        font-weight: 600;
        font-size: 1.25rem;
        color: var(--neutral-800);
        margin-bottom: 0.5rem;
    }
    
    .ultra-loading-subtext {
        color: var(--neutral-600);
    }
    
    /* Analysis Results */
    .ultra-results {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border-radius: var(--card-radius);
        border: 1px solid var(--glass-border);
        box-shadow: var(--glass-shadow);
        padding: 2rem;
        margin-top: 2rem;
    }
    
    .ultra-results-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .ultra-results-header h3 {
        color: var(--neutral-800);
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .ultra-results-header p {
        color: var(--neutral-600);
    }
    
    .ultra-section {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.03);
        transition: var(--transition-smooth);
        transform: translateY(20px);
        opacity: 0;
    }
    
    .ultra-section.animated {
        transform: translateY(0);
        opacity: 1;
    }
    
    .ultra-section:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
    }
    
    .ultra-section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 1rem;
    }
    
    .ultra-section-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background-color: var(--primary-light);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .ultra-section-icon.ultra-icon-success {
        background-color: var(--secondary-light);
        color: var(--secondary-color);
    }
    
    .ultra-section-icon.ultra-icon-danger {
        background-color: var(--danger-light);
        color: var(--danger-color);
    }
    
    .ultra-section-icon.ultra-icon-warning {
        background-color: var(--accent-light);
        color: var(--accent-color);
    }
    
    .ultra-section-icon.ultra-icon-primary {
        background-color: var(--primary-light);
        color: var(--primary-color);
    }
    
    .ultra-section h5 {
        margin: 0;
        font-weight: 600;
        color: var(--neutral-800);
    }
    
    /* Sentiment */
    .ultra-sentiment {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .ultra-sentiment-positive {
        background-color: var(--secondary-light);
        color: var(--secondary-color);
    }
    
    .ultra-sentiment-neutral {
        background-color: rgba(107, 114, 128, 0.1);
        color: var(--neutral-600);
    }
    
    .ultra-sentiment-negative {
        background-color: var(--danger-light);
        color: var(--danger-color);
    }
    
    .ultra-progress {
        height: 8px;
        background-color: var(--neutral-200);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 1rem;
    }
    
    .ultra-progress-bar {
        height: 100%;
        background-color: var(--primary-color);
        border-radius: 4px;
    }
    
    /* Tags */
    .ultra-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .ultra-tag-primary {
        background-color: var(--primary-light);
        color: var(--primary-color);
    }
    
    .ultra-tag-success {
        background-color: var(--secondary-light);
        color: var(--secondary-color);
    }
    
    .ultra-tag-warning {
        background-color: var(--accent-light);
        color: var(--accent-color);
    }
    
    .ultra-tag-light {
        background-color: var(--neutral-100);
        color: var(--neutral-600);
    }
    
    /* Lists */
    .ultra-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .ultra-list-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--neutral-200);
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    
    .ultra-list-item:last-child {
        border-bottom: none;
    }
    
    /* Action Items */
    .ultra-action-items {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .ultra-action-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 1rem;
        background-color: var(--neutral-50);
        border-radius: 10px;
        transition: var(--transition-smooth);
    }
    
    .ultra-action-item:hover {
        background-color: var(--primary-light);
        transform: translateX(5px);
    }
    
    .ultra-action-number {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
        flex-shrink: 0;
    }
    
    .ultra-action-text {
        flex: 1;
    }
    
    /* Animations */
    .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .ultra-fade-in {
        opacity: 0;
        animation: fadeIn 0.8s ease-in-out forwards;
    }
    
    .ultra-slide-up {
        opacity: 0;
        transform: translateY(30px);
        animation: slideUp 0.8s ease-in-out forwards;
        animation-delay: 0.2s;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Audio Player Styling */
    audio {
        width: 100%;
        height: 40px;
        border-radius: 8px;
    }
    
    audio::-webkit-media-controls-panel {
        background-color: var(--neutral-100);
    }
    
    audio::-webkit-media-controls-play-button {
        background-color: var(--primary-color);
        border-radius: 50%;
        color: white;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .ultra-glass-card {
            padding: 1.5rem;
        }
        
        .ultra-tabs {
            overflow-x: auto;
        }
        
        .ultra-tabs .nav-link {
            padding: 0.75rem 1rem;
        }
        
        .ultra-file-upload {
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="ultra-results-header text-center ultra-fade-in">
                    <h3>Nouvelle Entrée de Journal</h3>
                    <p>Exprimez vos pensées, partagez vos moments et découvrez des insights avec l'analyse IA</p>
                </div>
                
                <div class="ultra-glass-card ultra-slide-up">
                    {% csrf_token %}
                    <div class="ultra-tabs" id="journalTabsContainer">
                        <div class="nav-indicator" id="navIndicator"></div>
                        <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" role="tab">
                            <i class="fas fa-pen-alt me-2"></i>Texte
                        </button>
                        <button class="nav-link" id="audio-tab" data-bs-toggle="tab" data-bs-target="#audio" role="tab">
                            <i class="fas fa-microphone me-2"></i>Audio
                        </button>
                        <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image" role="tab">
                            <i class="fas fa-image me-2"></i>Image
                        </button>
                    </div>
                    
                    <div class="tab-content" id="journalTabsContent">
                        <div class="tab-pane fade show active" id="text" role="tabpanel">
                            <div class="mb-4">
                                <h5 class="mb-3">Exprimez vos pensées</h5>
                                <p class="text-muted mb-4">Partagez vos réflexions, sentiments et expériences pour une analyse personnalisée</p>
                                
                                <div class="ultra-card">
                                    <div class="ultra-card-header">
                                        <div class="ultra-card-icon">
                                            <i class="fas fa-pen-alt"></i>
                                        </div>
                                        <h6>Journal textuel</h6>
                                    </div>
                                    <div class="ultra-card-body">
                                        <p class="text-muted mb-3">Notre IA analysera votre texte pour identifier les émotions, thèmes et insights</p>
                                        
                                        <div class="floating-input-group">
                                            <textarea class="floating-input" id="journalText" placeholder=" " rows="8"></textarea>
                                            <label class="floating-label">Comment vous sentez-vous aujourd'hui ?</label>
                                        </div>
                                        
                                        <div class="mt-3 d-flex justify-content-between text-muted">
                                            <small id="charCount">0 caractères</small>
                                            <small><i class="fas fa-lightbulb me-1"></i> Plus vous écrivez, plus l'analyse sera riche</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="audio" role="tabpanel">
                            <div class="mb-4">
                                <h5 class="mb-3">Partagez vos pensées en audio</h5>
                                <p class="text-muted mb-4">Enregistrez votre voix ou téléchargez un fichier audio pour l'analyser avec notre IA</p>
                                
                                <div class="ultra-card mb-4">
                                    <div class="ultra-card-header">
                                        <div class="ultra-card-icon">
                                            <i class="fas fa-microphone"></i>
                                        </div>
                                        <h6>Enregistrement vocal</h6>
                                    </div>
                                    <div class="ultra-card-body">
                                        <p class="text-muted mb-3">Parlez librement, notre IA analysera votre ton et vos émotions</p>
                                        
                                        <div class="recording-controls">
                                            <button type="button" id="startRecording" class="btn-ultra-modern btn-ultra-primary">
                                                <i class="fas fa-microphone me-2"></i> Commencer l'enregistrement
                                            </button>
                                            <button type="button" id="stopRecording" class="btn-ultra-modern btn-ultra-outline" disabled>
                                                <i class="fas fa-stop-circle me-2"></i> Arrêter
                                            </button>
                                            <div id="recordingIndicator" class="recording-indicator" style="display: none;">
                                                <i class="fas fa-circle"></i> Enregistrement en cours...
                                            </div>
                                        </div>
                                        
                                        <div class="ultra-preview" id="audioPreview"></div>
                                    </div>
                                </div>
                                
                                <div class="ultra-card">
                                    <div class="ultra-card-header">
                                        <div class="ultra-card-icon ultra-icon-secondary">
                                            <i class="fas fa-file-audio"></i>
                                        </div>
                                        <h6>Téléchargement audio</h6>
                                    </div>
                                    <div class="ultra-card-body">
                                        <p class="text-muted mb-3">Téléchargez un fichier audio existant pour l'analyser</p>
                                        
                                        <div class="ultra-file-upload">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <div class="upload-text">Télécharger un fichier audio</div>
                                            <div class="upload-hint">MP3, WAV ou OGG</div>
                                            <input type="file" id="audioFile" accept="audio/*">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="image" role="tabpanel">
                            <div class="mb-4">
                                <h5 class="mb-3">Partagez une image significative</h5>
                                <p class="text-muted mb-4">Téléchargez une image pour que notre IA l'analyse et en extraie des insights</p>
                                
                                <div class="ultra-card">
                                    <div class="ultra-card-header">
                                        <div class="ultra-card-icon ultra-icon-accent">
                                            <i class="fas fa-image"></i>
                                        </div>
                                        <h6>Téléchargement d'image</h6>
                                    </div>
                                    <div class="ultra-card-body">
                                        <p class="text-muted mb-3">Notre IA analysera le contenu, les couleurs et l'ambiance de votre image</p>
                                        
                                        <div class="ultra-file-upload">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <div class="upload-text">Glissez-déposez une image ici</div>
                                            <div class="upload-hint">JPG, PNG ou GIF</div>
                                            <input type="file" id="imageFile" accept="image/*">
                                        </div>
                                        
                                        <div class="ultra-preview" id="imagePreview"></div>
                                        
                                        <div class="mt-3 text-center ultra-image-tips">
                                            <small class="text-muted">
                                                <i class="fas fa-lightbulb me-1"></i> Astuce : Les images avec des sujets clairs et une bonne luminosité donnent de meilleurs résultats d'analyse
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-center mt-5">
                        <button type="button" id="saveJournalButton" class="btn-ultra-modern btn-ultra-secondary btn-lg">
                            <i class="fas fa-brain me-2"></i>Analyser et enregistrer
                        </button>
                    </div>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted">L'analyse prend généralement 10-15 secondes selon la complexité du contenu</small>
                    </div>
                </div>
                
                <!-- Ultra Loading Spinner -->
                <div class="ultra-loading" id="loadingSpinner" style="display: none;">
                    <div class="ultra-spinner"></div>
                    <div class="ultra-loading-text">Analyse en cours</div>
                    <div class="ultra-loading-subtext">Notre IA analyse votre contenu en profondeur...</div>
                    <div class="ultra-loading-progress mt-4">
                        <div class="ultra-progress">
                            <div id="loadingProgressBar" class="ultra-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="mt-2 text-muted ultra-loading-steps">
                            <span id="loadingStep">Préparation de l'analyse...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Ultra Analysis Results -->
                <div id="analysisResults" class="ultra-results" style="display: none;">
                    <div class="ultra-results-header">
                        <h3>Résultats de l'Analyse</h3>
                        <p>Voici ce que notre IA a découvert dans votre contenu</p>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="ultra-section stagger-item">
                                <div class="ultra-section-header">
                                    <div class="ultra-section-icon">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <h5>Sentiment</h5>
                                </div>
                                <div id="sentimentResult" class="mb-3"></div>
                                <div class="ultra-progress">
                                    <div id="sentimentScore" class="ultra-progress-bar" style="width: 0%;"></div>
                                </div>
                            </div>
                            
                            <div class="ultra-section stagger-item">
                                <div class="ultra-section-header">
                                    <div class="ultra-section-icon">
                                        <i class="fas fa-tags"></i>
                                    </div>
                                    <h5>Mots-clés</h5>
                                </div>
                                <div id="keywordsResult" class="mt-3"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="ultra-section stagger-item">
                                <div class="ultra-section-header">
                                    <div class="ultra-section-icon">
                                        <i class="fas fa-layer-group"></i>
                                    </div>
                                    <h5>Thèmes</h5>
                                </div>
                                <div id="topicsResult" class="mt-3"></div>
                            </div>
                            
                            <div class="ultra-section stagger-item" id="imageSection">
                                <div class="ultra-section-header">
                                    <div class="ultra-section-icon">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <h5>Analyse d'Image</h5>
                                </div>
                                <div id="imageCaptionResult" class="mt-3 mb-2"></div>
                                <div id="imageSceneResult"></div>
                            </div>
                            
                            <div class="ultra-section stagger-item" id="audioSection">
                                <div class="ultra-section-header">
                                    <div class="ultra-section-icon">
                                        <i class="fas fa-microphone"></i>
                                    </div>
                                    <h5>Transcription Audio (Speech-to-Text)</h5>
                                </div>
                                <div class="mt-3">
                                    <div class="alert alert-info mb-2" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(16, 185, 129, 0.1)); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 12px;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <small>Voici ce qui a été dit dans votre enregistrement audio :</small>
                                    </div>
                                    <div id="audioTranscriptionResult" class="p-3 rounded" style="background: rgba(255,255,255,0.6); border-left: 4px solid var(--primary-color); font-size: 1.05rem; line-height: 1.6; font-style: italic; color: var(--neutral-800);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Section -->
                    <div class="ultra-section stagger-item mt-4">
                        <div class="ultra-section-header">
                            <div class="ultra-section-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <h5>Résumé</h5>
                        </div>
                        <div id="summaryResult" class="mt-3 p-3 rounded" style="background: rgba(255,255,255,0.1);"></div>
                    </div>
                    
                    <!-- Detailed Summary Section -->
                    <div class="ultra-section stagger-item mt-4">
                        <div class="ultra-section-header">
                            <div class="ultra-section-icon">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <h5>Résumé Détaillé</h5>
                        </div>
                        <div id="detailedSummaryResult" class="mt-3 p-3 rounded" style="background: rgba(255,255,255,0.1);"></div>
                    </div>
                    
                    <!-- Positive & Negative Aspects -->
                    <div class="row g-4 mt-2">
                        <div class="col-md-6">
                            <div class="ultra-section stagger-item">
                                <div class="ultra-section-header">
                                    <div class="ultra-section-icon ultra-icon-success">
                                        <i class="fas fa-plus-circle"></i>
                                    </div>
                                    <h5>Points Positifs</h5>
                                </div>
                                <div id="positiveAspectsResult" class="mt-3"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="ultra-section stagger-item">
                                <div class="ultra-section-header">
                                    <div class="ultra-section-icon ultra-icon-danger">
                                        <i class="fas fa-minus-circle"></i>
                                    </div>
                                    <h5>Points à Améliorer</h5>
                                </div>
                                <div id="negativeAspectsResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Items -->
                    <div class="ultra-section stagger-item mt-4">
                        <div class="ultra-section-header">
                            <div class="ultra-section-icon ultra-icon-primary">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <h5>Actions Suggérées</h5>
                        </div>
                        <div id="actionItemsResult" class="mt-3"></div>
                    </div>
                    
                    <!-- Mood Analysis -->
                    <div class="ultra-section stagger-item mt-4">
                        <div class="ultra-section-header">
                            <div class="ultra-section-icon ultra-icon-warning">
                                <i class="fas fa-smile-beam"></i>
                            </div>
                            <h5>Analyse d'Humeur</h5>
                        </div>
                        <div id="moodAnalysisResult" class="mt-3 p-3 rounded" style="background: rgba(255,255,255,0.1);"></div>
                    </div>
                    
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <button type="button" id="saveJournalButton" class="btn-ultra-modern btn-ultra-secondary">
                            <i class="fas fa-save me-2"></i>Sauvegarder
                        </button>
                        <button type="button" id="newAnalysisButton" class="btn-ultra-modern btn-ultra-outline">
                            <i class="fas fa-redo me-2"></i>Nouvelle analyse
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables for media recording and storage
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let imageFile = null;
        
        // Character counter for text input
        const journalText = document.getElementById('journalText');
        const charCount = document.getElementById('charCount');
        
        journalText.addEventListener('input', () => {
            const count = journalText.value.length;
            charCount.textContent = count + (count === 1 ? ' caractère' : ' caractères');
        });
        
        // Initialize tab indicator
        const tabsContainer = document.getElementById('journalTabsContainer');
        const navIndicator = document.getElementById('navIndicator');
        const tabs = tabsContainer.querySelectorAll('.nav-link');
        
        // Set initial position of indicator
        function setIndicatorPosition(element) {
            navIndicator.style.left = element.offsetLeft + 'px';
            navIndicator.style.width = element.offsetWidth + 'px';
        }
        
        // Initialize indicator position
        setIndicatorPosition(document.querySelector('.nav-link.active'));
        
        // Update indicator on tab click and activate Bootstrap tabs
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                setIndicatorPosition(tab);
                
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Get the target tab content id from data-bs-target attribute
                const targetId = tab.getAttribute('data-bs-target');
                
                // Hide all tab panes
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });
                
                // Show the target tab pane
                const targetPane = document.querySelector(targetId);
                if (targetPane) {
                    targetPane.classList.add('show', 'active');
                }
            });
        });
        
        // DOM Elements
        const startRecordingBtn = document.getElementById('startRecording');
        const stopRecordingBtn = document.getElementById('stopRecording');
        const audioFileInput = document.getElementById('audioFile');
        const imageFileInput = document.getElementById('imageFile');
        const audioPreview = document.getElementById('audioPreview');
        const imagePreview = document.getElementById('imagePreview');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const analysisResults = document.getElementById('analysisResults');
        const saveJournalButton = document.getElementById('saveJournalButton');
        const newAnalysisButton = document.getElementById('newAnalysisButton');
        
        // Audio recording functionality with modern UI
        const recordingIndicator = document.getElementById('recordingIndicator');
        
        startRecordingBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    // Hide recording indicator
                    recordingIndicator.style.display = 'none';
                    
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Clear previous preview
                    audioPreview.innerHTML = '';
                    
                    // Create audio element with modern styling
                    const audioContainer = document.createElement('div');
                    audioContainer.className = 'mt-3 p-3 rounded';
                    audioContainer.style.backgroundColor = 'var(--neutral-100)';
                    
                    const audioElement = document.createElement('audio');
                    audioElement.controls = true;
                    audioElement.className = 'w-100';
                    audioElement.src = audioUrl;
                    
                    audioContainer.appendChild(audioElement);
                    audioPreview.appendChild(audioContainer);
                    
                    // Add success message
                    const successMessage = document.createElement('div');
                    successMessage.className = 'mt-2 text-success';
                    successMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i>Enregistrement terminé avec succès';
                    audioPreview.appendChild(successMessage);
                    
                    // Reset recording state
                    startRecordingBtn.disabled = false;
                    stopRecordingBtn.disabled = true;
                    audioChunks = [];
                };
                
                // Start recording
                mediaRecorder.start();
                startRecordingBtn.disabled = true;
                stopRecordingBtn.disabled = false;
                
                // Show recording indicator
                recordingIndicator.style.display = 'flex';
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Impossible d\'accéder au microphone. Veuillez vérifier les permissions.');
            }
        });
        
        stopRecordingBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        });
        
        // Modern file upload handling
        audioFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                audioBlob = file;
                
                // Clear previous preview
                audioPreview.innerHTML = '';
                
                // Create audio element with modern styling
                const audioContainer = document.createElement('div');
                audioContainer.className = 'mt-3 p-3 rounded animate-fade-in';
                audioContainer.style.backgroundColor = 'var(--neutral-100)';
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'mb-2 d-flex align-items-center';
                fileInfo.innerHTML = `
                    <i class="fas fa-file-audio text-primary me-2"></i>
                    <span>${file.name}</span>
                    <span class="ms-2 badge bg-light text-dark">${(file.size / 1024).toFixed(1)} KB</span>
                `;
                
                const audioElement = document.createElement('audio');
                audioElement.controls = true;
                audioElement.className = 'w-100';
                audioElement.src = URL.createObjectURL(file);
                
                audioContainer.appendChild(fileInfo);
                audioContainer.appendChild(audioElement);
                audioPreview.appendChild(audioContainer);
            }
        });
        
        imageFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                imageFile = file;
                
                // Clear previous preview
                imagePreview.innerHTML = '';
                
                // Create image card with modern styling
                const imageCard = document.createElement('div');
                imageCard.className = 'mt-3 card border-0 shadow-sm rounded overflow-hidden animate-fade-in';
                
                // Create card header with file info
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header bg-light d-flex align-items-center';
                cardHeader.innerHTML = `
                    <i class="fas fa-file-image text-primary me-2"></i>
                    <span>${file.name}</span>
                    <span class="ms-2 badge bg-light text-dark">${(file.size / 1024).toFixed(1)} KB</span>
                `;
                
                // Create image element
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.alt = 'Image preview';
                img.className = 'card-img-bottom';
                img.style.maxHeight = '300px';
                img.style.objectFit = 'cover';
                
                imageCard.appendChild(cardHeader);
                imageCard.appendChild(img);
                imagePreview.appendChild(imageCard);
            }
        });
        
        // Helper function to convert Blob/File to base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    // Remove the data URL prefix (e.g., "data:image/png;base64,")
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        // Function to analyze journal content
        async function analyzeJournalContent() {
            const journalText = document.getElementById('journalText').value.trim();
            
            // Check if at least one input is provided
            if (!journalText && !audioBlob && !imageFile) {
                // Modern error notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-danger animate-fade-in';
                notification.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Veuillez ajouter du texte, un enregistrement audio ou une image.';
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.maxWidth = '400px';
                notification.style.zIndex = '1050';
                document.body.appendChild(notification);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s ease-in-out';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
                
                return false;
            }
            
            // Show loading spinner with animated progress
            loadingSpinner.style.display = 'flex';
            analysisResults.style.display = 'none';
            
            // Scroll to loading spinner
            loadingSpinner.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Animate loading progress
            const loadingProgressBar = document.getElementById('loadingProgressBar');
            const loadingStep = document.getElementById('loadingStep');
            const loadingSteps = [
                'Préparation de l\'analyse...',
                'Extraction des caractéristiques...',
                'Analyse des émotions...',
                'Identification des thèmes...',
                'Génération des insights...',
                'Finalisation des résultats...'
            ];
            
            // Reset progress bar
            loadingProgressBar.style.width = '0%';
            
            // Animate progress bar
            let currentStep = 0;
            const progressInterval = setInterval(() => {
                const progress = (currentStep + 1) / loadingSteps.length;
                loadingProgressBar.style.transition = 'width 0.8s ease-in-out';
                loadingProgressBar.style.width = `${progress * 100}%`;
                loadingStep.textContent = loadingSteps[currentStep];
                
                currentStep++;
                if (currentStep >= loadingSteps.length) {
                    clearInterval(progressInterval);
                }
            }, 1500);
            
            // Create JSON payload with base64 encoded files
            const payload = {};
            
            if (journalText) {
                payload.text = journalText;
            }
            
            // Convert audio to base64 if present
            if (audioBlob) {
                const audioBase64 = await blobToBase64(audioBlob);
                payload.audio_data = audioBase64;
                payload.audio_filename = audioBlob.name || 'recording.wav';
            }
            
            // Convert image to base64 if present
            if (imageFile) {
                const imageBase64 = await blobToBase64(imageFile);
                payload.image_data = imageBase64;
                payload.image_filename = imageFile.name;
            }
            
            // Add user ID if available
            const userId = '{{ user.id }}';
            if (userId && userId !== '') {
                payload.user_id = userId;
            }
            
            // Debug: Log what we're sending
            console.log('JSON payload keys:', Object.keys(payload));
            if (payload.text) console.log('  text:', payload.text.substring(0, 50) + '...');
            if (payload.audio_data) console.log('  audio_data: <base64 data>');
            if (payload.image_data) console.log('  image_data: <base64 data>');
            
            try {
                // Get CSRF token
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // Send request to API
                const response = await fetch('/api/analyse/v2/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(payload),
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                // Clear the progress interval if it's still running
                clearInterval(progressInterval);
                
                // Complete the progress bar animation
                loadingProgressBar.style.width = '100%';
                loadingStep.textContent = 'Analyse terminée avec succès!';
                
                // Short delay before showing results
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const analysisData = await response.json();
                displayAnalysisResults(analysisData);
                return true;
                
            } catch (error) {
                console.error('Error during analysis:', error);
                
                // Modern error notification
                const errorNotification = document.createElement('div');
                errorNotification.className = 'alert alert-danger animate-fade-in';
                errorNotification.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Une erreur est survenue lors de l\'analyse. Veuillez réessayer.';
                errorNotification.style.position = 'fixed';
                errorNotification.style.top = '20px';
                errorNotification.style.right = '20px';
                errorNotification.style.maxWidth = '400px';
                errorNotification.style.zIndex = '1050';
                document.body.appendChild(errorNotification);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    errorNotification.style.opacity = '0';
                    errorNotification.style.transition = 'opacity 0.5s ease-in-out';
                    setTimeout(() => errorNotification.remove(), 500);
                }, 5000);
                
                return false;
                
            } finally {
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
            }
        }
        
        // Display analysis results with ultra-modern styling
        function displayAnalysisResults(data) {
            // Show results container
            analysisResults.style.display = 'block';
            
            // Scroll to results with smooth animation
            setTimeout(() => {
                analysisResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
            
            // Animate stagger items
            const staggerItems = document.querySelectorAll('.stagger-item');
            staggerItems.forEach((item, index) => {
                setTimeout(() => {
                    item.classList.add('animated');
                }, 150 * index);
            });
            
            // Sentiment and Emotions
            const sentimentElement = document.getElementById('sentimentResult');
            const sentimentScoreElement = document.getElementById('sentimentScore');
            
            let sentimentClass = '';
            let sentimentIcon = '';
            
            switch (data.sentiment) {
                case 'positif':
                    sentimentClass = 'ultra-sentiment-positive';
                    sentimentIcon = 'fa-face-smile';
                    break;
                case 'neutre':
                    sentimentClass = 'ultra-sentiment-neutral';
                    sentimentIcon = 'fa-face-meh';
                    break;
                case 'negatif':
                    sentimentClass = 'ultra-sentiment-negative';
                    sentimentIcon = 'fa-face-frown';
                    break;
            }
            
            // Display sentiment with emotions if available
            let emotionsHtml = '';
            if (data.emotions_detected && data.emotions_detected.length > 0) {
                emotionsHtml = `<div class="mt-2">
                    <small class="text-muted">Émotions détectées:</small>
                    <div class="mt-1">
                        ${data.emotions_detected.map(emotion => 
                            `<span class="ultra-tag ultra-tag-light">${emotion}</span>`
                        ).join('')}
                    </div>
                </div>`;
            }
            
            sentimentElement.innerHTML = `<div class="ultra-sentiment ${sentimentClass}"><i class="far ${sentimentIcon}"></i> ${data.sentiment.charAt(0).toUpperCase() + data.sentiment.slice(1)}</div>${emotionsHtml}`;
            
            // Sentiment score with animation
            const scorePercentage = Math.round(data.emotion_score * 100);
            sentimentScoreElement.style.width = '0%';
            setTimeout(() => {
                sentimentScoreElement.style.transition = 'width 1.5s cubic-bezier(0.19, 1, 0.22, 1)';
                sentimentScoreElement.style.width = `${scorePercentage}%`;
            }, 500);
            
            // Keywords with staggered animation
            const keywordsElement = document.getElementById('keywordsResult');
            keywordsElement.innerHTML = '';
            
            if (data.keywords && data.keywords.length > 0) {
                data.keywords.forEach((keyword, index) => {
                    const tag = document.createElement('span');
                    tag.className = 'ultra-tag ultra-tag-primary';
                    tag.textContent = keyword;
                    tag.style.opacity = '0';
                    tag.style.transform = 'translateY(20px)';
                    keywordsElement.appendChild(tag);
                    
                    // Staggered animation
                    setTimeout(() => {
                        tag.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                        tag.style.opacity = '1';
                        tag.style.transform = 'translateY(0)';
                    }, 150 * index + 300);
                });
            } else {
                keywordsElement.textContent = 'Aucun mot-clé détecté';
            }
            
            // Topics with staggered animation
            const topicsElement = document.getElementById('topicsResult');
            topicsElement.innerHTML = '';
            
            if (data.topics && data.topics.length > 0) {
                data.topics.forEach((topic, index) => {
                    const tag = document.createElement('span');
                    tag.className = 'ultra-tag ultra-tag-success';
                    tag.textContent = topic;
                    tag.style.opacity = '0';
                    tag.style.transform = 'translateY(20px)';
                    topicsElement.appendChild(tag);
                    
                    // Staggered animation
                    setTimeout(() => {
                        tag.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                        tag.style.opacity = '1';
                        tag.style.transform = 'translateY(0)';
                    }, 150 * index + 500);
                });
            } else {
                topicsElement.textContent = 'Aucun thème détecté';
            }
            
            // Summary with fade-in animation
            const summaryElement = document.getElementById('summaryResult');
            summaryElement.textContent = data.summary || 'Aucun résumé disponible';
            summaryElement.style.opacity = '0';
            setTimeout(() => {
                summaryElement.style.transition = 'opacity 0.8s ease-in-out';
                summaryElement.style.opacity = '1';
            }, 800);
            
            // Detailed Summary with fade-in animation
            const detailedSummaryElement = document.getElementById('detailedSummaryResult');
            detailedSummaryElement.textContent = data.detailed_summary || 'Aucun résumé détaillé disponible';
            detailedSummaryElement.style.opacity = '0';
            setTimeout(() => {
                detailedSummaryElement.style.transition = 'opacity 0.8s ease-in-out';
                detailedSummaryElement.style.opacity = '1';
            }, 1000);
            
            // Positive Aspects
            const positiveAspectsElement = document.getElementById('positiveAspectsResult');
            positiveAspectsElement.innerHTML = '';
            
            if (data.positive_aspects && data.positive_aspects.length > 0) {
                const list = document.createElement('ul');
                list.className = 'list-group list-group-flush ultra-list';
                
                data.positive_aspects.forEach((aspect, index) => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item border-0 bg-transparent ultra-list-item';
                    item.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${aspect}`;
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(20px)';
                    list.appendChild(item);
                    
                    // Staggered animation
                    setTimeout(() => {
                        item.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                    }, 150 * index + 300);
                });
                
                positiveAspectsElement.appendChild(list);
            } else {
                positiveAspectsElement.textContent = 'Aucun point positif identifié';
            }
            
            // Negative Aspects
            const negativeAspectsElement = document.getElementById('negativeAspectsResult');
            negativeAspectsElement.innerHTML = '';
            
            if (data.negative_aspects && data.negative_aspects.length > 0) {
                const list = document.createElement('ul');
                list.className = 'list-group list-group-flush ultra-list';
                
                data.negative_aspects.forEach((aspect, index) => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item border-0 bg-transparent ultra-list-item';
                    item.innerHTML = `<i class="fas fa-exclamation-circle text-danger me-2"></i>${aspect}`;
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(20px)';
                    list.appendChild(item);
                    
                    // Staggered animation
                    setTimeout(() => {
                        item.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                    }, 150 * index + 300);
                });
                
                negativeAspectsElement.appendChild(list);
            } else {
                negativeAspectsElement.textContent = 'Aucun point négatif identifié';
            }
            
            // Action Items
            const actionItemsElement = document.getElementById('actionItemsResult');
            actionItemsElement.innerHTML = '';
            
            if (data.action_items && data.action_items.length > 0) {
                const list = document.createElement('div');
                list.className = 'ultra-action-items';
                
                data.action_items.forEach((item, index) => {
                    const actionItem = document.createElement('div');
                    actionItem.className = 'ultra-action-item';
                    actionItem.innerHTML = `
                        <div class="ultra-action-number">${index + 1}</div>
                        <div class="ultra-action-text">${item}</div>
                    `;
                    actionItem.style.opacity = '0';
                    actionItem.style.transform = 'translateY(20px)';
                    list.appendChild(actionItem);
                    
                    // Staggered animation
                    setTimeout(() => {
                        actionItem.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                        actionItem.style.opacity = '1';
                        actionItem.style.transform = 'translateY(0)';
                    }, 150 * index + 300);
                });
                
                actionItemsElement.appendChild(list);
            } else {
                actionItemsElement.textContent = 'Aucune action suggérée';
            }
            
            // Mood Analysis
            const moodAnalysisElement = document.getElementById('moodAnalysisResult');
            moodAnalysisElement.textContent = data.mood_analysis || 'Aucune analyse d\'humeur disponible';
            moodAnalysisElement.style.opacity = '0';
            setTimeout(() => {
                moodAnalysisElement.style.transition = 'opacity 0.8s ease-in-out';
                moodAnalysisElement.style.opacity = '1';
            }, 1200);
            
            // Image analysis
            const imageSection = document.getElementById('imageSection');
            const imageCaptionElement = document.getElementById('imageCaptionResult');
            const imageSceneElement = document.getElementById('imageSceneResult');
            
            if (data.image_caption || data.image_scene) {
                imageSection.style.display = 'block';
                imageCaptionElement.innerHTML = `<div class="p-3 rounded" style="background: rgba(255,255,255,0.1);">
                    ${data.image_caption || 'Aucune description disponible'}
                    ${data.image_analysis ? `<div class="mt-2 pt-2 border-top"><strong>Analyse:</strong> ${data.image_analysis}</div>` : ''}
                </div>`;
                
                if (data.image_scene) {
                    imageSceneElement.innerHTML = `<span class="ultra-tag ultra-tag-warning mt-2"><i class="fas fa-map-marker-alt me-2"></i> ${data.image_scene}</span>`;
                } else {
                    imageSceneElement.textContent = '';
                }
            } else {
                imageSection.style.display = 'none';
            }
            
            // Audio transcription (Speech-to-Text)
            const audioSection = document.getElementById('audioSection');
            const audioTranscriptionElement = document.getElementById('audioTranscriptionResult');
            
            if (data.audio_transcription) {
                audioSection.style.display = 'block';
                // Display with nice animation
                audioTranscriptionElement.style.opacity = '0';
                audioTranscriptionElement.innerHTML = `<i class="fas fa-quote-left me-2" style="color: var(--primary-color);"></i>${data.audio_transcription}<i class="fas fa-quote-right ms-2" style="color: var(--primary-color);"></i>`;
                setTimeout(() => {
                    audioTranscriptionElement.style.transition = 'opacity 0.8s ease-in-out';
                    audioTranscriptionElement.style.opacity = '1';
                }, 1200);
            } else {
                audioSection.style.display = 'none';
            }
            
            // Store analysis ID if available
            if (data.analyse_id || data.analysis_id) {
                saveJournalButton.dataset.analyseId = data.analyse_id || data.analysis_id;
            }
            
            // Add confetti effect for a delightful touch
            addConfettiEffect();
        }
        
        // Confetti effect for results
        function addConfettiEffect() {
            const confettiCount = 100;
            const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#3b82f6'];
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = Math.random() * 10 + 5 + 'px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.borderRadius = '50%';
                confetti.style.opacity = Math.random() * 0.5 + 0.5;
                confetti.style.pointerEvents = 'none';
                
                // Position at top of results
                const resultsRect = analysisResults.getBoundingClientRect();
                confetti.style.left = resultsRect.left + Math.random() * resultsRect.width + 'px';
                confetti.style.top = window.scrollY + resultsRect.top + 'px';
                
                // Add to DOM
                document.body.appendChild(confetti);
                
                // Animate
                const animation = confetti.animate([
                    { transform: 'translate(0, 0)', opacity: 1 },
                    { transform: `translate(${Math.random() * 100 - 50}px, ${Math.random() * 200 + 100}px)`, opacity: 0 }
                ], {
                    duration: Math.random() * 2000 + 1000,
                    easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                });
                
                // Remove after animation
                animation.onfinish = () => {
                    document.body.removeChild(confetti);
                };
            }
        }
        
        // Save journal button with automatic analysis
        saveJournalButton.addEventListener('click', async () => {
            // Disable the button and show loading state
            saveJournalButton.disabled = true;
            saveJournalButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Analyse et enregistrement...';
            
            // First analyze the journal content
            const analysisSuccess = await analyzeJournalContent();
            
            if (analysisSuccess) {
                // Show success notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-success animate-fade-in';
                notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Votre journal a été analysé et enregistré avec succès ! Redirection vers la liste...';
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.maxWidth = '400px';
                notification.style.zIndex = '1050';
                document.body.appendChild(notification);
                
                // Redirect to journal list after 2 seconds
                setTimeout(() => {
                    window.location.href = '/journal/';
                }, 2000);
            } else {
                // Reset button state if analysis failed
                saveJournalButton.disabled = false;
                saveJournalButton.innerHTML = '<i class="fas fa-save me-2"></i>Enregistrer';
            }
        });
        
        // New analysis button
        newAnalysisButton.addEventListener('click', () => {
            // Reset form
            document.getElementById('journalText').value = '';
            audioPreview.innerHTML = '';
            imagePreview.innerHTML = '';
            audioBlob = null;
            imageFile = null;
            
            // Hide results
            analysisResults.style.display = 'none';
            
            // Switch to text tab
            const textTab = document.getElementById('text-tab');
            bootstrap.Tab.getOrCreateInstance(textTab).show();
        });
    });
</script>
{% endblock %}
