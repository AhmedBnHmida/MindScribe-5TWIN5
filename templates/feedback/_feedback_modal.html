<!-- Feedback Rating Modal - Show after 5+ journals -->
<div class="modal fade" id="feedbackRatingModal" tabindex="-1" aria-labelledby="feedbackRatingModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px 20px 0 0; padding: 2rem;">
                <h5 class="modal-title" id="feedbackRatingModalLabel" style="font-size: 1.5rem; font-weight: 700;">
                    <i class="fas fa-heart me-2"></i>Vous appr√©ciez MindScribe ?
                </h5>
            </div>
            <div class="modal-body" style="padding: 2.5rem;">
                <p class="text-center mb-4" style="font-size: 1.1rem; color: #495057;">
                    Nous avons remarqu√© que vous utilisez r√©guli√®rement notre application. 
                    <br>Votre avis nous serait tr√®s pr√©cieux ! ‚ú®
                </p>
                
                <div id="rating-section" class="mb-4">
                    <div class="text-center mb-4">
                        <div class="star-rating-modal d-flex justify-content-center gap-2" style="font-size: 2.5rem;">
                            <i class="fas fa-star star-modal" data-rating="1"></i>
                            <i class="fas fa-star star-modal" data-rating="2"></i>
                            <i class="fas fa-star star-modal" data-rating="3"></i>
                            <i class="fas fa-star star-modal" data-rating="4"></i>
                            <i class="fas fa-star star-modal" data-rating="5"></i>
                        </div>
                        <small class="text-muted mt-2 d-block">Cliquez sur les √©toiles pour noter</small>
                        <input type="hidden" id="modal-rating-input" value="0">
                    </div>
                </div>
                
                <div id="feedback-section" class="d-none">
                    <div class="mb-4">
                        <label for="modal-feedback-text" class="form-label fw-bold" style="color: #495057;">
                            <i class="fas fa-comment-dots me-2"></i>Partagez votre exp√©rience (optionnel)
                        </label>
                        <textarea class="form-control" 
                                  id="modal-feedback-text" 
                                  rows="4" 
                                  placeholder="Qu'est-ce qui vous pla√Æt dans MindScribe ? Qu'est-ce qui pourrait √™tre am√©lior√© ?"
                                  style="border-radius: 12px; border: 2px solid #e9ecef; resize: none;"></textarea>
                    </div>
                    
                    <button type="button" class="btn w-100" id="submit-feedback-btn"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; font-weight: 600; border-radius: 12px; padding: 0.75rem; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                        <i class="fas fa-paper-plane me-2"></i>Envoyer mon retour
                    </button>
                </div>
                
                <div class="d-flex gap-2 mt-3" id="initial-buttons">
                    <button type="button" class="btn btn-outline-secondary w-100" id="later-btn" style="border-radius: 12px; font-weight: 600;">
                        <i class="fas fa-clock me-2"></i>Plus tard
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.star-modal {
    cursor: pointer;
    color: #e9ecef;
    transition: all 0.2s;
}

.star-modal:hover {
    transform: scale(1.2);
}

.star-modal.active {
    color: #ffc107;
    transform: scale(1.2);
}

#submit-feedback-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if modal should be shown
    fetch('/feedback/check-modal/')
        .then(response => response.json())
        .then(data => {
            if (data.should_show) {
                const modal = new bootstrap.Modal(document.getElementById('feedbackRatingModal'));
                // Show modal after a short delay
                setTimeout(() => modal.show(), 1000);
            }
        })
        .catch(error => console.error('Error checking modal:', error));
    
    // Star rating functionality
    const stars = document.querySelectorAll('.star-modal');
    const ratingInput = document.getElementById('modal-rating-input');
    const ratingSection = document.getElementById('rating-section');
    const feedbackSection = document.getElementById('feedback-section');
    const initialButtons = document.getElementById('initial-buttons');
    let currentRating = 0;
    
    stars.forEach(star => {
        star.addEventListener('mouseenter', function() {
            const rating = parseInt(this.dataset.rating);
            highlightModalStars(rating);
        });
        
        star.addEventListener('click', function() {
            currentRating = parseInt(this.dataset.rating);
            ratingInput.value = currentRating;
            highlightModalStars(currentRating, true);
            
            // Show feedback section and hide initial buttons
            setTimeout(() => {
                ratingSection.style.display = 'none';
                feedbackSection.classList.remove('d-none');
                initialButtons.classList.add('d-none');
            }, 300);
        });
    });
    
    document.querySelector('.star-rating-modal').addEventListener('mouseleave', function() {
        if (currentRating > 0) {
            highlightModalStars(currentRating, true);
        } else {
            resetModalStars();
        }
    });
    
    function highlightModalStars(rating, permanent = false) {
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }
    
    function resetModalStars() {
        stars.forEach(star => {
            star.classList.remove('active');
        });
    }
    
    // Submit feedback
    document.getElementById('submit-feedback-btn').addEventListener('click', function() {
        const rating = ratingInput.value;
        const feedbackText = document.getElementById('modal-feedback-text').value;
        
        if (rating === '0') {
            alert('Veuillez s√©lectionner une note');
            return;
        }
        
        const formData = new FormData();
        formData.append('rating', rating);
        formData.append('feedback_text', feedbackText);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('/feedback/create/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show thank you message
                document.querySelector('#feedbackRatingModal .modal-body').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle" style="font-size: 4rem; color: #3ab795;"></i>
                        <h4 class="mt-3">Merci pour votre retour ! üéâ</h4>
                        <p class="text-muted">Votre avis nous aide √† am√©liorer MindScribe.</p>
                    </div>
                `;
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('feedbackRatingModal')).hide();
                }, 2000);
            }
        })
        .catch(error => console.error('Error submitting feedback:', error));
    });
    
    // Later button
    document.getElementById('later-btn').addEventListener('click', function() {
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('/feedback/dismiss-modal/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(() => {
            bootstrap.Modal.getInstance(document.getElementById('feedbackRatingModal')).hide();
        })
        .catch(error => console.error('Error dismissing modal:', error));
    });
});
</script>

